<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<th:block layout:fragment="title">
    <title>Batch Trigger- 중계서버</title>
</th:block>
<th:block layout:fragment="script">
</th:block>
<div layout:fragment="content">
    <body>
        <section id="admin">
            <nav th:replace="fragments/sidebar :: sidebarFragment" />
            <div class="content">
                <nav th:replace="fragments/topbar :: topbarFragment" />
                <div class="bottom">
                    <div class="left">
                        <b><h1>Batch Trigger- 중계서버</h1></b>
                    </div>
                    <div class="right">
                    </div>
                </div>
                <div id="real">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="analytics">
                                <div class="card">
                                    <div class="text">
                                        <p>
                                            <strong>트리거를 등록하기 전 배치 별 job 파일과, context-scheduler-job.xml에 등록되어 있어야 합니다.</strong><br>
                                            src/main/resources/egovframework/batch/job 하위의 job 파일과,<br>
                                            context-scheduler-job.xml을 확인 후 등록하시길 바랍니다.<br>
                                            <br>
                                            등록된 트리거 : <span th:text="${totalTriggerCount}"></span> 개
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="jsGrid"/>
                </div>
            </div>
        </section>
        <script th:inline="javascript">
            $(function () {

                let data = [[ ${triggerList} ]];

                $("#jsGrid").jsGrid({
                    width: "100%",
                    height: "100%",

                    filtering: false,
                    editing: true,
                    sorting: true,
                    paging: false,

                    updateButtonTooltip: "스케줄 수정",
                    updateOnResize: true,

                    data: data,
                    controller: data,

                    rowClick: function (args) {
                        showDetailsDialog("Edit", args.item);
                    },

                    controller: {
                        updateItem: function (item) {
                            return $.ajax({
                                type: "PUT",
                                contentType: "application/json",
                                dataType: "text",
                                url: "/trigger/items",
                                data: JSON.stringify(item),
                            }).done(function () {
                                location.reload();
                            })
                        },
                        deleteItem: function (item) {
                            return $.ajax({
                                type: "DELETE",
                                contentType: "application/json",
                                dataType: "text",
                                url: "/batch/items",
                                data: JSON.stringify(item),
                            }).done(function () {
                                location.reload();
                            })
                        },
                    },

                    onItemUpdated: function (args) {
                        let previousTriggerName = args.previousItem.triggerName;
                        alert(previousTriggerName + '스케줄을 변경하였습니다.');
                    },

                    fields: [
                        {name: "idx", title: "IDX", type: "number", width: 5, align: "center", editing: false},
                        {name: "triggerName", title: "Trigger", type: "text", align: "center", editing: true},
                        {
                            type: "control",
                            modeSwitchButton: false,
                            editButton: false,
                            headerTemplate: function () {
                                return $("<button>").attr("type", "button").text("Add")
                                    .on("click", function () {
                                        showDetailsDialog("Add", {});
                                    });
                            }
                        }
                    ],
                });

                $("#detailsDialog").dialog({
                    autoOpen: false,
                    width: 400,
                    close: function () {
                        $("#detailsForm").validate().resetForm();
                        $("#detailsForm").find(".error").removeClass("error");
                    }
                });

                $("#detailsForm").validate({
                    rules: {
                        triggerName: "required",
                    },
                    messages: {
                        triggerName: "Please enter name",
                    },
                    submitHandler: function () {
                        formSubmitHandler();
                    }
                });

                var formSubmitHandler = $.noop;

                var showDetailsDialog = function (dialogType, trigger) {
                    $("#idx").val(trigger.idx);
                    $("#triggerName").val(trigger.triggerName);

                    formSubmitHandler = function () {
                        saveClient(client, dialogType === "Add");
                    };

                    $("#detailsDialog").dialog("option", "title", dialogType + " Client")
                        .dialog("open");
                };

                var saveClient = function (client, isNew) {
                    $.extend(client, {
                        Name: $("#name").val(),
                    });

                    $("#jsGrid").jsGrid(isNew ? "insertItem" : "updateItem", client);

                    $("#detailsDialog").dialog("close");
                };
            });
        </script>
    </body>
</div>
</html>